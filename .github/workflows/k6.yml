name: load-test.js Performance Tests

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Run every Monday at 2 AM
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress

jobs:
  k6-smoke-test:
    name: load-test.js Smoke Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.test_type == 'smoke'

    services:
      api:
        image: ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Wait for API and run smoke test
        env:
          API_URL: http://localhost:8080
          # Set to 'false' to prevent k6 from exiting with a non-zero code on threshold failure
          K6_FAIL_ON_THRESHOLD: "false"
        run: |
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/health > /dev/null; then
              echo "API is ready!"
              sleep 5 # Give it extra time to stabilize
              break
            fi
            if [ $i -eq 30 ]; then
              echo "API failed to become ready"
              exit 1
            fi
            echo "Attempt $i/30: API not ready yet, waiting..."
            sleep 2
          done

          echo "Creating reports directory..."
          mkdir -p reports

          echo "Running k6 smoke test..."
          # The '|| true' ensures the step succeeds even if k6 finds issues, allowing artifact upload
          k6 run --vus 1 --duration 30s \
            --summary-export=reports/k6-smoke-summary.json \
            tests/k6/load-test.js || true

      - name: Upload k6 smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-smoke-results
          path: reports/

      - name: Check smoke test results
        id: k6_results
        run: |
          # This step will fail the job if the failure rate is > 0
          # You can adjust the '0.0' to a more lenient threshold, e.g., '0.01' for 1%
          FAILED_RATE=$(jq -r '.metrics.http_req_failed.values.rate' reports/k6-smoke-summary.json)
          if (( $(echo "$FAILED_RATE > 0.0" | bc -l) )); then
            echo "Smoke test failed: Request failure rate is $(echo "$FAILED_RATE * 100" | bc -l)%."
            exit 1
          else
            echo "Smoke test passed: Request failure rate is 0%."
          fi

  k6-load-test:
    name: load-test.js Load Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'load' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to test environment
        run: |
          echo "Deploying to test environment..."
          # Add your deployment logic here

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 load test
        env:
          API_URL: ${{ secrets.TEST_ENV_URL }}
        run: |
          mkdir -p reports
          k6 run --out json=reports/k6-load-results.json \
            --summary-export=reports/k6-load-summary.json \
            tests/k6/load-test.js

      - name: Process results
        run: |
          echo "### ðŸ“ˆ k6 Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat reports/k6-load-summary.json | jq -r '
            "**VUs:** \(.metrics.vus.values.max)",
            "**Requests:** \(.metrics.http_reqs.values.count)",
            "**Failed Requests:** \(.metrics.http_req_failed.values.rate * 100)%",
            "**Avg Duration:** \(.metrics.http_req_duration.values.avg)ms",
            "**P95 Duration:** \(.metrics.http_req_duration.values["p(95)"])ms",
            "**P99 Duration:** \(.metrics.http_req_duration.values["p(99)"])ms"
          ' >> $GITHUB_STEP_SUMMARY

      - name: Upload k6 load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-load-results
          path: reports/

      - name: Check thresholds
        run: |
          FAILED=$(jq -r '.metrics.http_req_failed.values.rate' reports/k6-load-summary.json)
          if (( $(echo "$FAILED > 0.1" | bc -l) )); then
            echo "âŒ Error rate too high: $FAILED"
            exit 1
          fi

  k6-stress-test:
    name: load-test.js Stress Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'stress'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to test environment
        run: |
          echo "Deploying to test environment..."

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 stress test
        env:
          API_URL: ${{ secrets.TEST_ENV_URL }}
        run: |
          mkdir -p reports
          k6 run --out json=reports/k6-stress-results.json \
            --summary-export=reports/k6-stress-summary.json \
            --config tests/k6/stress-config.json \
            tests/k6/load-test.js

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-stress-results
          path: reports/

      - name: Analyze breaking point
        run: |
          echo "### ðŸ’¥ Stress Test - Breaking Point Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Add analysis logic here