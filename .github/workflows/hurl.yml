name: Hurl Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  hurl-tests:
    name: Hurl Declarative API Tests
    runs-on: ubuntu-latest

    permissions:
      checks: write
      pull-requests: write
      contents: read

    services:
      api:
        image: ghcr.io/${{ github.repository }}:${{ github.ref_name }}
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Hurl
        run: |
          VERSION=4.3.0
          curl -LO https://github.com/Orange-OpenSource/hurl/releases/download/$VERSION/hurl_${VERSION}_amd64.deb
          sudo dpkg -i hurl_${VERSION}_amd64.deb

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            sleep 2
          done

      - name: Run Hurl tests
        run: |
          mkdir -p reports/hurl
          hurl --test \
            --variable base_url=http://localhost:8080 \
            --report-html reports/hurl \
            --report-junit reports/hurl/junit.xml \
            --json \
            --color \
            tests/hurl/*.hurl > reports/hurl/results.json

      - name: Generate test summary
        if: always()
        run: |
          echo "### üî• Hurl Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/hurl/results.json ]; then
            # Use --slurp to read the stream of JSON objects into an array
            jq --slurp -r '
              "**Total Tests:** \(length)",
              "**Passed:** ‚úÖ \(map(select(.success == true)) | length)",
              "**Failed:** ‚ùå \(map(select(.success == false)) | length)",
              "**Duration:** \([.[] | .time_in_ms] | add)ms",
              "",
              "#### Failed Tests",
              (map(select(.success == false)) |
                if length > 0 then
                  map("- ‚ùå \(.filename)") | join("\n")
                else
                  "_No failures_ ‚ú®"
                end
              )
            ' reports/hurl/results.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Hurl reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hurl-reports
          path: reports/hurl/

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/hurl/junit.xml
          check_name: Hurl Test Results

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('reports/hurl/results.json')) {
              console.log('No results file found');
              return;
            }

            const results = JSON.parse(fs.readFileSync('reports/hurl/results.json', 'utf8'));

            const passed = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            const total = results.length;

            let failureDetails = '';
            if (failed > 0) {
              failureDetails = '\n\n#### Failed Tests:\n' +
                results
                  .filter(r => !r.success)
                  .map(r => `- ‚ùå ${r.filename}`)
                  .join('\n');
            }

            const summary = `
            ### üî• Hurl Test Results

            - **Total:** ${total}
            - **Passed:** ‚úÖ ${passed}
            - **Failed:** ‚ùå ${failed}
            - **Success Rate:** ${total > 0 ? ((passed/total)*100).toFixed(1) : "100"}%
            ${failureDetails}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Fail if tests failed
        if: always()
        run: |
          if [ -f reports/hurl/results.json ]; then
            # Use --slurp to read the stream of JSON objects into an array
            FAILURES=$(jq --slurp '[.[] | select(.success == false)] | length' reports/hurl/results.json)
            if [ "$FAILURES" -gt 0 ]; then
              echo "‚ùå $FAILURES test(s) failed"
              exit 1
            fi
          fi